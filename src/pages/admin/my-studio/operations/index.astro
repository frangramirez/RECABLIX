---
import AdminLayout from '@/layouts/AdminLayout.astro'
import { AdminOperationsManager } from '@/components/admin/AdminOperationsManager'
import { createSupabaseServerClient } from '@/lib/auth'
import { supabaseAdmin } from '@/lib/supabase'

// Obtener studio del superadmin
const studio = Astro.locals.studio
let superadminStudioId: string | null = null

if (studio?.is_superadmin && supabaseAdmin) {
  const { data: membership } = await supabaseAdmin
    .from('studio_members')
    .select('studio_id')
    .eq('user_id', studio.id)
    .single()

  if (membership) {
    superadminStudioId = membership.studio_id
  }
}

// También verificar si hay studioId en query param (para impersonate)
const queryStudioId = Astro.url.searchParams.get('studioId')
const effectiveStudioId = queryStudioId || superadminStudioId

// Obtener período activo
const supabase = createSupabaseServerClient(Astro.cookies)
const { data: activePeriod } = await supabase
  .from('reca_periods')
  .select('sales_period_start, sales_period_end')
  .eq('is_active', true)
  .single()
---

<AdminLayout title="Operaciones">
  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold">Operaciones</h1>
        <p class="text-muted-foreground text-sm">Gestiona ventas y compras de todos los clientes</p>
      </div>
    </div>
    <AdminOperationsManager
      client:load
      ownStudioId={effectiveStudioId}
      activePeriod={activePeriod}
    />
  </div>
</AdminLayout>
