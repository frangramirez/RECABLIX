---
import AdminLayout from '@/layouts/AdminLayout.astro'
import { ClientForm } from '@/components/studio/ClientForm'
import { supabaseAdmin } from '@/lib/supabase'

const { id } = Astro.params
const studioId = Astro.locals.studio?.id

if (!studioId) return Astro.redirect('/admin/my-studio/setup')
if (!supabaseAdmin) return Astro.redirect('/admin')

const { data: client } = await supabaseAdmin
  .from('clients')
  .select(`
    id,
    name,
    cuit,
    apps,
    studio_id,
    reca_client_data (
      activity,
      province_code,
      works_in_rd,
      is_retired,
      dependents,
      local_m2,
      annual_rent,
      annual_mw,
      previous_category,
      previous_fee,
      is_exempt,
      has_multilateral,
      has_local,
      rents_local,
      lessor_cuit
    )
  `)
  .eq('id', id)
  .eq('studio_id', studioId)
  .single()

if (!client) return Astro.redirect('/admin/my-studio/clients')

// Flatten nested structure for form
const reca = (client.reca_client_data as any)?.[0] || {}
const apps = (client.apps as string[]) || []
const flattenedClient = {
  id: client.id,
  name: client.name,
  cuit: client.cuit,
  uses_recablix: apps.includes('recablix'),
  activity: reca.activity || 'SERVICIOS',
  province_code: reca.province_code || '901',
  works_in_rd: reca.works_in_rd || false,
  is_retired: reca.is_retired || false,
  dependents: reca.dependents || 0,
  local_m2: reca.local_m2,
  annual_rent: reca.annual_rent,
  annual_mw: reca.annual_mw,
  previous_category: reca.previous_category,
  previous_fee: reca.previous_fee,
  is_exempt: reca.is_exempt || false,
  has_multilateral: reca.has_multilateral || false,
  has_local: reca.has_local || false,
  rents_local: reca.rents_local || false,
  lessor_cuit: reca.lessor_cuit || null,
}
---

<AdminLayout title="Editar Cliente">
  <div class="space-y-6">
    <div class="flex items-center gap-4">
      <a href="/admin/my-studio/clients" class="text-muted-foreground hover:text-foreground">
        &larr; Volver a clientes
      </a>
    </div>
    <h1 class="text-2xl font-bold">Editar Cliente</h1>
    <ClientForm client:load initialData={flattenedClient} studioId={studioId} />
  </div>
</AdminLayout>
