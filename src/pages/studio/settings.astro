---
/**
 * Página de Configuración del Studio
 *
 * Permite a owners/admins gestionar miembros y permisos
 */
import StudioLayout from '@/layouts/StudioLayout.astro'
import { getStudioFromSession } from '@/lib/auth'
import { MembersManager } from '@/components/studio/MembersManager'
import { supabaseAdmin } from '@/lib/supabase'
import type { SubscriptionLimits, SubscriptionUsage } from '@/types/subscription'

const session = await getStudioFromSession(Astro.cookies, Astro.request)

if (!session) {
  return Astro.redirect('/login')
}

// Solo owner y admin pueden acceder
if (!session.is_superadmin && session.role !== 'owner' && session.role !== 'admin') {
  return Astro.redirect('/studio')
}

// Obtener límites del studio
let subscriptionLimits: SubscriptionLimits | null = null
let subscriptionUsage: SubscriptionUsage | null = null

if (supabaseAdmin) {
  try {
    // Obtener límites
    const { data: studio } = await supabaseAdmin
      .from('studios')
      .select('subscription_limits')
      .eq('id', session.studio.id)
      .single()

    subscriptionLimits = studio?.subscription_limits || {
      max_admins: null,
      max_collaborators: null,
      max_clients: null,
    }

    // Contar uso actual
    const { count: adminCount } = await supabaseAdmin
      .from('studio_members')
      .select('id', { count: 'exact', head: true })
      .eq('studio_id', session.studio.id)
      .eq('role', 'admin')

    const { count: collaboratorCount } = await supabaseAdmin
      .from('studio_members')
      .select('id', { count: 'exact', head: true })
      .eq('studio_id', session.studio.id)
      .eq('role', 'collaborator')

    const { count: clientCount } = await supabaseAdmin
      .from('studio_members')
      .select('id', { count: 'exact', head: true })
      .eq('studio_id', session.studio.id)
      .eq('role', 'client')

    subscriptionUsage = {
      admins: adminCount || 0,
      collaborators: collaboratorCount || 0,
      clients: clientCount || 0,
    }
  } catch (error) {
    console.error('Error fetching subscription limits:', error)
  }
}
---

<StudioLayout title="Configuración">
  <div class="space-y-6">
    <div>
      <h1 class="text-2xl font-bold text-foreground">Configuración del Studio</h1>
      <p class="text-muted-foreground mt-1">{session.studio.name}</p>
    </div>

    <div class="bg-card rounded-lg border p-6">
      <MembersManager
        client:load
        subscriptionLimits={subscriptionLimits}
        subscriptionUsage={subscriptionUsage}
        showLimits={true}
      />
    </div>
  </div>
</StudioLayout>
