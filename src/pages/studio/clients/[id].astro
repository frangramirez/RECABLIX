---
import StudioLayout from '@/layouts/StudioLayout.astro'
import { ClientForm } from '@/components/studio/ClientForm'
import { createSupabaseServerClient } from '@/lib/auth'

const { id } = Astro.params
const supabase = createSupabaseServerClient(Astro.cookies)
const studioId = Astro.locals.studio?.id

if (!studioId) return Astro.redirect('/login')

const { data: client } = await supabase
  .from('clients')
  .select(`
    id,
    name,
    cuit,
    reca_client_data (
      activity,
      province_code,
      works_in_rd,
      is_retired,
      dependents,
      local_m2,
      annual_rent,
      annual_mw,
      previous_category,
      previous_fee
    )
  `)
  .eq('id', id)
  .single()

if (!client) return Astro.redirect('/studio/clients')

// Flatten nested structure for form
const reca = (client.reca_client_data as any)?.[0] || {}
const flattenedClient = {
  id: client.id,
  name: client.name,
  cuit: client.cuit,
  activity: reca.activity || 'SERVICIOS',
  province_code: reca.province_code || '901',
  works_in_rd: reca.works_in_rd || false,
  is_retired: reca.is_retired || false,
  dependents: reca.dependents || 0,
  local_m2: reca.local_m2,
  annual_rent: reca.annual_rent,
  annual_mw: reca.annual_mw,
  previous_category: reca.previous_category,
  previous_fee: reca.previous_fee,
}
---

<StudioLayout title="Editar Cliente">
  <div class="space-y-6">
    <h1 class="text-2xl font-bold text-gray-900">Editar Cliente</h1>
    <ClientForm client:load initialData={flattenedClient} studioId={studioId} />
  </div>
</StudioLayout>
