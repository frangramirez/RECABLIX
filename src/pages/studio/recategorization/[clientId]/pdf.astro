---
import StudioLayout from '@/layouts/StudioLayout.astro'
import { createSupabaseServerClient } from '@/lib/auth'

const studio = Astro.locals.studio
if (!studio) return Astro.redirect('/login')

const { clientId } = Astro.params
const supabase = createSupabaseServerClient(Astro.cookies)

// Verificar que el cliente existe y pertenece al studio
const { data: client } = await supabase
  .from('clients')
  .select('name')
  .eq('id', clientId)
  .eq('studio_id', studio.id)
  .single()

if (!client) return Astro.redirect('/studio/recategorization')
---
<StudioLayout title={`PDF: ${client.name}`}>
  <div class="space-y-6">
    <div class="flex items-center justify-between">
      <div>
        <a href="/studio/recategorization" class="text-gray-500 hover:text-gray-700 text-sm">
          ← Volver a Recategorización
        </a>
        <h1 class="text-2xl font-bold text-gray-900 mt-2">PDF: {client.name}</h1>
      </div>
      <div class="flex gap-2">
        <a
          href={`/api/pdf/${clientId}`}
          target="_blank"
          class="inline-flex items-center px-4 py-2 border rounded-lg hover:bg-gray-50 text-gray-700"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          Ver en nueva pestaña
        </a>
        <a
          href={`/api/pdf/${clientId}?download=1`}
          download
          class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
            <polyline points="7 10 12 15 17 10"/>
            <line x1="12" x2="12" y1="15" y2="3"/>
          </svg>
          Descargar PDF
        </a>
      </div>
    </div>

    <div class="bg-white rounded-xl border p-4">
      <iframe
        src={`/api/pdf/${clientId}`}
        class="w-full h-[800px] rounded border"
        title={`PDF de ${client.name}`}
      />
    </div>
  </div>
</StudioLayout>
